<template>
    <div class="slds-var-p-around_medium">
        
        <!-- Step 1: Test Type Selection -->
        <div if:true={showTestTypeSelection}>
            <lightning-card title="Step 1: Select Test Type" icon-name="standard:prompt">
                <div class="slds-var-p-horizontal_medium">
                    
                    <div class="slds-var-m-bottom_medium">
                        <p class="slds-text-body_regular">
                            Choose the type of Einstein Service Cloud test you want to perform:
                        </p>
                    </div>

                    <!-- Test Type Options -->
                    <div class="slds-grid slds-gutters slds-wrap slds-var-m-bottom_large">
                        <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3">
                            <div class="slds-box slds-box_link slds-text-align_center test-type-card" 
                                 onclick={handleSelectServiceReplies}
                                 data-test-type="Service Replies">
                                <lightning-icon icon-name="standard:live_chat" size="medium" class="slds-var-m-bottom_small"></lightning-icon>
                                <h3 class="slds-text-heading_small">Service Replies</h3>
                                <p class="slds-text-body_small">
                                    Test Einstein service reply suggestions for chat conversations. Uses contextual and grounded templates.
                                </p>
                                <div class="slds-var-m-top_small">
                                    <lightning-badge label="Chat & Messaging" variant="brand"></lightning-badge>
                                </div>
                            </div>
                        </div>
                        
                        <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3">
                            <div class="slds-box slds-box_link slds-text-align_center test-type-card" 
                                 onclick={handleSelectCaseSummary}
                                 data-test-type="Case Summary">
                                <lightning-icon icon-name="standard:case" size="medium" class="slds-var-m-bottom_small"></lightning-icon>
                                <h3 class="slds-text-heading_small">Case Summary</h3>
                                <p class="slds-text-body_small">
                                    Test Einstein case summarization for support cases. Uses a single summary template.
                                </p>
                                <div class="slds-var-m-top_small">
                                    <lightning-badge label="Case Records" variant="success"></lightning-badge>
                                </div>
                            </div>
                        </div>
                        
                        <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3">
                            <div class="slds-box slds-box_link slds-text-align_center test-type-card" 
                                 onclick={handleSelectWorkSummary}
                                 data-test-type="Work Summary">
                                <lightning-icon icon-name="standard:work_summary" size="medium" class="slds-var-m-bottom_small"></lightning-icon>
                                <h3 class="slds-text-heading_small">Work Summary</h3>
                                <p class="slds-text-body_small">
                                    Test Einstein work summarization for conversations and calls. Uses a single summary template.
                                </p>
                                <div class="slds-var-m-top_small">
                                    <lightning-badge label="Chat & Voice" variant="warning"></lightning-badge>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Selected Test Type Display -->
                    <template if:true={selectedTestType}>
                        <div class="slds-var-m-bottom_medium">
                            <div class="slds-box slds-theme_shade">
                                <div class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center">
                                    <div class="slds-col">
                                        <h3 class="slds-text-heading_small">Selected Test Type: {selectedTestType}</h3>
                                        <p class="slds-text-body_small">{testTypeDescription}</p>
                                    </div>
                                    <div class="slds-col slds-no-flex">
                                        <lightning-button
                                            variant="brand"
                                            label="Continue to Template Selection"
                                            onclick={handleContinueToTemplates}>
                                        </lightning-button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </lightning-card>
        </div>

        <!-- Step 2: Template Selection -->
        <div if:true={showTemplateSelection}>
            <lightning-card title="Step 2: Select Prompt Templates" icon-name="standard:prompt">
                <div class="slds-var-p-horizontal_medium">
                    
                    <!-- Back Button -->
                    <div class="slds-var-m-bottom_medium">
                        <lightning-button
                            label="← Back to Test Type Selection"
                            variant="neutral"
                            onclick={handleBackToTestTypes}>
                        </lightning-button>
                    </div>

                    <!-- Selected Test Type Summary -->
                    <div class="slds-var-m-bottom_medium">
                        <div class="slds-box slds-theme_shade">
                            <p class="slds-text-body_small">
                                <strong>Selected Test Type:</strong> {selectedTestType}
                            </p>
                        </div>
                    </div>
                    
                    <!-- Template Selection Status -->
                    <div class="slds-grid slds-gutters slds-var-m-bottom_medium">
                        <div class="slds-col" lwc:if={requiresPrimaryTemplate}>
                            <div class="slds-box slds-theme_shade slds-text-align_center">
                                <h3 class="slds-text-heading_small">{primaryTemplateLabel}</h3>
                                <p class="slds-text-body_regular">
                                    <template if:true={selectedPrimaryTemplate}>
                                        <lightning-badge label={selectedPrimaryTemplate.Name} variant="success"></lightning-badge>
                                    </template>
                                    <template if:false={selectedPrimaryTemplate}>
                                        <lightning-badge label="Not Selected" variant="lightest"></lightning-badge>
                                    </template>
                                </p>
                            </div>
                        </div>
                        <div class="slds-col" lwc:if={requiresSecondaryTemplate}>
                            <div class="slds-box slds-theme_shade slds-text-align_center">
                                <h3 class="slds-text-heading_small">{secondaryTemplateLabel}</h3>
                                <p class="slds-text-body_regular">
                                    <template if:true={selectedSecondaryTemplate}>
                                        <lightning-badge label={selectedSecondaryTemplate.Name} variant="success"></lightning-badge>
                                    </template>
                                    <template if:false={selectedSecondaryTemplate}>
                                        <lightning-badge label="Not Selected" variant="lightest"></lightning-badge>
                                    </template>
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Knowledge Grounding Configuration -->
                    <template if:true={showKnowledgeGroundingConfig}>
                        <div class="slds-var-m-bottom_medium">
                            <div class="slds-card">
                                <div class="slds-card__header">
                                    <h3 class="slds-text-heading_small">
                                        <lightning-icon icon-name="utility:knowledge_base" size="small" class="slds-var-m-right_x-small"></lightning-icon>
                                        Knowledge Grounding Configuration
                                    </h3>
                                </div>
                                <div class="slds-card__body slds-card__body_inner">
                                    <div class="slds-grid slds-gutters">
                                        <template if:true={selectedPrimaryTemplate}>
                                            <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2">
                                                <div class="slds-box">
                                                    <h4 class="slds-text-heading_small slds-var-m-bottom_small">{primaryTemplateLabel}</h4>
                                                    <p class="slds-text-body_small slds-text-color_weak slds-var-m-bottom_small">
                                                        {selectedPrimaryTemplate.Name}
                                                    </p>
                                                    <lightning-input
                                                        type="toggle"
                                                        label="Uses Knowledge Grounding"
                                                        checked={primaryUsesKnowledgeGrounding}
                                                        message-when-active="Template uses knowledge retrieval"
                                                        message-when-inactive="Template does not use knowledge retrieval"
                                                        onchange={handlePrimaryKnowledgeGroundingChange}>
                                                    </lightning-input>
                                                </div>
                                            </div>
                                        </template>
                                        <template if:true={selectedSecondaryTemplate}>
                                            <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2">
                                                <div class="slds-box">
                                                    <h4 class="slds-text-heading_small slds-var-m-bottom_small">{secondaryTemplateLabel}</h4>
                                                    <p class="slds-text-body_small slds-text-color_weak slds-var-m-bottom_small">
                                                        {selectedSecondaryTemplate.Name}
                                                    </p>
                                                    <lightning-input
                                                        type="toggle"
                                                        label="Uses Knowledge Grounding"
                                                        checked={secondaryUsesKnowledgeGrounding}
                                                        message-when-active="Template uses knowledge retrieval"
                                                        message-when-inactive="Template does not use knowledge retrieval"
                                                        onchange={handleSecondaryKnowledgeGroundingChange}>
                                                    </lightning-input>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                    <div class="slds-var-m-top_medium">
                                        <div class="slds-box slds-theme_info">
                                            <p class="slds-text-body_small">
                                                <lightning-icon icon-name="utility:info" size="xx-small" class="slds-var-m-right_xx-small"></lightning-icon>
                                                Knowledge grounding determines whether RAGAS quality assessment will be performed. 
                                                Enable this for templates that use Einstein Search or knowledge retrieval features.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Retriever Configuration (for Service Replies only) -->
                    <template if:true={showRetrieverConfig}>
                        <div class="slds-var-m-bottom_medium">
                            <div class="slds-card">
                                <div class="slds-card__header">
                                    <h3 class="slds-text-heading_small">Retriever Configuration</h3>
                                </div>
                                <div class="slds-card__body slds-card__body_inner">
                                    <lightning-input
                                        type="text"
                                        label="Retriever ID"
                                        value={selectedRetrieverId}
                                        placeholder="Enter Einstein retriever ID"
                                        help-text="Enter the Einstein retriever ID for grounded template processing"
                                        required
                                        onchange={handleRetrieverIdChange}>
                                    </lightning-input>
                                    <template if:true={defaultRetrieverId}>
                                        <p class="slds-text-body_small slds-text-color_weak slds-var-m-top_x-small">
                                            Default retriever: {defaultRetrieverId}
                                        </p>
                                    </template>
                                    <template if:false={defaultRetrieverId}>
                                        <p class="slds-text-body_small slds-text-color_weak slds-var-m-top_x-small">
                                            No default retriever configured. Ask your admin to set the Default Retriever ID in the component design properties.
                                        </p>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Quality Assessment Configuration -->
                    <div class="slds-var-m-bottom_medium">
                        <div class="slds-card">
                            <div class="slds-card__header">
                                <h3 class="slds-text-heading_small">
                                    <lightning-icon icon-name="standard:metrics" size="small" class="slds-var-m-right_x-small"></lightning-icon>
                                    RAGAS Quality Assessment
                                </h3>
                            </div>
                            <div class="slds-card__body slds-card__body_inner">
                                <!-- Quality Assessment Toggle -->
                                <div class="slds-var-m-bottom_medium">
                                    <lightning-input
                                        type="toggle"
                                        label="Enable Quality Assessment"
                                        checked={enableQualityAssessment}
                                        message-when-active="Quality metrics will be calculated after test completion"
                                        message-when-inactive="Quality metrics will not be calculated"
                                        onchange={handleQualityAssessmentToggle}>
                                    </lightning-input>
                                    <p class="slds-text-body_small slds-text-color_weak slds-var-m-top_x-small">
                                        Enable RAGAS (Retrieval-Augmented Generation Assessment) quality metrics to evaluate response faithfulness, relevancy, and context quality.
                                    </p>
                                </div>

                                <!-- Quality Assessment Template Configuration -->
                                <template if:true={enableQualityAssessment}>
                                    <div class="slds-grid slds-gutters slds-wrap">
                                        <!-- Faithfulness Assessment -->
                                        <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3">
                                            <div class="slds-box quality-metric-box">
                                                <div class="slds-var-m-bottom_small">
                                                    <h4 class="slds-text-heading_small">
                                                        <lightning-icon icon-name="utility:shield" size="xx-small" class="slds-var-m-right_xx-small"></lightning-icon>
                                                        Faithfulness
                                                    </h4>
                                                    <p class="slds-text-body_small slds-text-color_weak">
                                                        Anti-hallucination scoring to ensure responses are grounded in source context
                                                    </p>
                                                </div>
                                                <lightning-input
                                                    type="text"
                                                    label="Faithfulness Template ID"
                                                    value={faithfulnessTemplateId}
                                                    placeholder="Enter template ID"
                                                    field-level-help="Default configured by admin. Override if needed."
                                                    onchange={handleFaithfulnessTemplateChange}>
                                                </lightning-input>
                                            </div>
                                        </div>

                                        <!-- Relevancy Assessment -->
                                        <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3">
                                            <div class="slds-box quality-metric-box">
                                                <div class="slds-var-m-bottom_small">
                                                    <h4 class="slds-text-heading_small">
                                                        <lightning-icon icon-name="utility:target" size="xx-small" class="slds-var-m-right_xx-small"></lightning-icon>
                                                        Relevancy
                                                    </h4>
                                                    <p class="slds-text-body_small slds-text-color_weak">
                                                        Measures how well responses address user questions and needs
                                                    </p>
                                                </div>
                                                <lightning-input
                                                    type="text"
                                                    label="Relevancy Template ID"
                                                    value={relevancyTemplateId}
                                                    placeholder="Enter template ID"
                                                    field-level-help="Default configured by admin. Override if needed."
                                                    onchange={handleRelevancyTemplateChange}>
                                                </lightning-input>
                                            </div>
                                        </div>

                                        <!-- Context Quality Assessment -->
                                        <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3">
                                            <div class="slds-box quality-metric-box">
                                                <div class="slds-var-m-bottom_small">
                                                    <h4 class="slds-text-heading_small">
                                                        <lightning-icon icon-name="utility:knowledge_base" size="xx-small" class="slds-var-m-right_xx-small"></lightning-icon>
                                                        Context Quality
                                                    </h4>
                                                    <p class="slds-text-body_small slds-text-color_weak">
                                                        Evaluates precision and recall of retrieved contextual information
                                                    </p>
                                                </div>
                                                <lightning-input
                                                    type="text"
                                                    label="Context Quality Template ID"
                                                    value={contextQualityTemplateId}
                                                    placeholder="Enter template ID"
                                                    field-level-help="Default configured by admin. Override if needed."
                                                    onchange={handleContextQualityTemplateChange}>
                                                </lightning-input>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Quality Assessment Status -->
                                    <div class="slds-var-m-top_medium">
                                        <div class="slds-box slds-theme_info">
                                            <div class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center">
                                                <div class="slds-col">
                                                    <p class="slds-text-body_small">
                                                        <lightning-icon icon-name="utility:info" size="xx-small" class="slds-var-m-right_xx-small"></lightning-icon>
                                                        Quality assessment will run automatically after test completion.
                                                        Configure at least one template ID above to enable specific metrics.
                                                    </p>
                                                </div>
                                                <div class="slds-col slds-no-flex">
                                                    <lightning-badge 
                                                        label={qualityAssessmentStatusLabel} 
                                                        variant={qualityAssessmentStatusVariant}>
                                                    </lightning-badge>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- Template Filters -->
                    <div class="slds-var-m-bottom_medium">
                        <div class="slds-card">
                            <div class="slds-card__header">
                                <h2 class="slds-card__header-title">
                                    <lightning-icon icon-name="utility:filter" size="small" class="slds-var-m-right_x-small"></lightning-icon>
                                    Prompt Template Filters
                                </h2>
                            </div>
                            <div class="slds-card__body slds-card__body_inner">
                                <div class="slds-grid slds-gutters slds-wrap">
                                    <!-- Template Name Filter -->
                                    <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3">
                                        <lightning-input
                                            type="text"
                                            label="Template Name"
                                            placeholder="Search by template name"
                                            value={templateNameFilter}
                                            onchange={handleTemplateNameFilterChange}>
                                        </lightning-input>
                                    </div>
                                    
                                    <!-- Template Type Filter -->
                                    <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3">
                                        <lightning-combobox
                                            label="Template Type"
                                            value={templateTypeFilter}
                                            placeholder="Select template type"
                                            options={templateTypeOptions}
                                            disabled={isTemplateTypeFilterDisabled}
                                            onchange={handleTemplateTypeFilterChange}>
                                        </lightning-combobox>
                                    </div>
                                    
                                    <!-- Template Status Filter -->
                                    <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3">
                                        <lightning-combobox
                                            label="Status"
                                            value={templateStatusFilter}
                                            placeholder="Select status"
                                            options={templateStatusOptions}
                                            onchange={handleTemplateStatusFilterChange}>
                                        </lightning-combobox>
                                    </div>
                                </div>
                                
                                <!-- Filter Action Buttons -->
                                <div class="slds-var-m-top_medium">
                                    <lightning-button-group>
                                        <lightning-button
                                            label="Apply Filters"
                                            variant="brand"
                                            onclick={handleApplyTemplateFilters}>
                                        </lightning-button>
                                        <lightning-button
                                            label="Clear Filters"
                                            variant="neutral"
                                            onclick={handleClearTemplateFilters}>
                                        </lightning-button>
                                    </lightning-button-group>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Template Count Display -->
                    <div class="slds-var-m-bottom_small">
                        <p class="slds-text-body_small slds-text-color_weak">
                            Showing {templateCurrentPageInfo}
                        </p>
                    </div>

                    <!-- Template Table -->
                    <div class="slds-var-m-bottom_medium">
                        <div class="template-table-container">
                            <!-- Loading Overlay -->
                            <template if:true={isLoadingTemplates}>
                                <div class="slds-is-relative">
                                    <div class="slds-spinner_container">
                                        <div class="slds-spinner slds-spinner_medium slds-spinner_brand" role="status">
                                            <span class="slds-assistive-text">Loading templates...</span>
                                            <div class="slds-spinner__dot-a"></div>
                                            <div class="slds-spinner__dot-b"></div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            
                            <!-- Template Table -->
                            <lightning-datatable
                                key-field="Id"
                                data={promptTemplates}
                                columns={templateColumns}
                                onrowaction={handleTemplateAction}
                                is-loading={isLoadingTemplates}>
                            </lightning-datatable>
                        </div>
                    </div>

                    <!-- Template Pagination Controls -->
                    <div class="slds-grid slds-grid_align-center slds-var-m-bottom_medium" if:true={templateTotalPages}>
                        <div class="slds-grid slds-grid_vertical-align-center">
                            <lightning-button-icon
                                icon-name="utility:chevronleft"
                                variant="border-filled"
                                alternative-text="First Page"
                                title="First Page"
                                onclick={handleTemplateFirstPage}
                                class="slds-var-m-right_xx-small">
                            </lightning-button-icon>
                            
                            <lightning-button-icon
                                icon-name="utility:back"
                                variant="border-filled"
                                alternative-text="Previous Page"
                                title="Previous Page"
                                onclick={handleTemplatePreviousPage}
                                class="slds-var-m-right_small">
                            </lightning-button-icon>
                            
                            <span class="slds-var-m-horizontal_small slds-text-body_small">
                                Page {templateCurrentPage} of {templateTotalPages}
                            </span>
                            
                            <lightning-button-icon
                                icon-name="utility:forward"
                                variant="border-filled"
                                alternative-text="Next Page"
                                title="Next Page"
                                onclick={handleTemplateNextPage}
                                class="slds-var-m-left_small">
                            </lightning-button-icon>
                            
                            <lightning-button-icon
                                icon-name="utility:chevronright"
                                variant="border-filled"
                                alternative-text="Last Page"
                                title="Last Page"
                                onclick={handleTemplateLastPage}
                                class="slds-var-m-left_xx-small">
                            </lightning-button-icon>
                        </div>
                    </div>

                    <!-- Continue Button -->
                    <div class="slds-text-align_center">
                        <lightning-button
                            variant="brand"
                            label={continueToRecordsLabel}
                            onclick={handleContinueToRecords}
                            disabled={continueToRecordsDisabled}>
                        </lightning-button>
                    </div>
                </div>
            </lightning-card>
        </div>

        <!-- Step 3: Record Selection -->
        <div if:true={showRecordSelection}>
            <lightning-card title={recordSelectionTitle} icon-name={recordSelectionIcon}>
                
                <!-- Back to Templates Button -->
                <div class="slds-var-m-around_medium">
                    <lightning-button
                        label="← Back to Template Selection"
                        variant="neutral"
                        onclick={handleBackToTemplates}
                        class="slds-var-m-bottom_medium">
                    </lightning-button>
                </div>

                <!-- Selected Templates Summary (Compact) -->
                <div class="slds-var-m-around_medium">
                    <div class="slds-box slds-theme_shade">
                        <p class="slds-text-body_small">
                            <strong>Test Type:</strong> {selectedTestType}<br/>
                            <template if:true={selectedPrimaryTemplate}>
                                <strong>{primaryTemplateLabel}:</strong> {selectedPrimaryTemplate.Name}<br/>
                            </template>
                            <template if:true={selectedSecondaryTemplate}>
                                <strong>{secondaryTemplateLabel}:</strong> {selectedSecondaryTemplate.Name}
                            </template>
                        </p>
                    </div>
                </div>
                
                <!-- Loading Spinner -->
                <template if:true={isLoadingRecords}>
                    <div class="slds-var-m-around_large slds-text-align_center">
                        <lightning-spinner 
                            alternative-text={loadingRecordsMessage} 
                            size="large">
                        </lightning-spinner>
                        <div class="slds-var-m-top_small">
                            <p class="slds-text-body_regular">{loadingRecordsMessage}</p>
                            <p class="slds-text-body_small slds-text-color_weak">This may take a moment as we fetch data.</p>
                        </div>
                    </div>
                </template>

                <!-- Record Selection Content -->
                <template if:false={isLoadingRecords}>
                    <!-- Filter Section -->
                    <div class="slds-var-m-around_medium">
                        <div class="slds-card">
                            <div class="slds-card__header">
                                <h2 class="slds-card__header-title">
                                    <lightning-icon icon-name="utility:filter" size="small" class="slds-var-m-right_x-small"></lightning-icon>
                                    Filters
                                </h2>
                            </div>
                            <div class="slds-card__body slds-card__body_inner">
                                <div class="slds-grid slds-gutters slds-wrap">
                                    <!-- Date Range Filters -->
                                    <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-4">
                                        <lightning-input
                                            type="date"
                                            label="Start Date"
                                            value={startDate}
                                            onchange={handleStartDateChange}>
                                        </lightning-input>
                                    </div>
                                    <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-4">
                                        <lightning-input
                                            type="date"
                                            label="End Date"
                                            value={endDate}
                                            onchange={handleEndDateChange}>
                                        </lightning-input>
                                    </div>
                                    
                                    <!-- Dynamic Record Filters Based on Test Type -->
                                    <template if:true={showMessagingFilters}>
                                        <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-4">
                                            <lightning-input
                                                type="text"
                                                label="Session Name"
                                                placeholder="Enter session name"
                                                value={sessionName}
                                                onchange={handleSessionNameChange}>
                                            </lightning-input>
                                        </div>
                                        
                                        <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-4">
                                            <lightning-combobox
                                                label="Status"
                                                value={selectedStatus}
                                                placeholder="Select status"
                                                options={statusOptions}
                                                onchange={handleStatusChange}>
                                            </lightning-combobox>
                                        </div>
                                    </template>

                                    <template if:true={showCaseFilters}>
                                        <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-4">
                                            <lightning-input
                                                type="text"
                                                label="Subject"
                                                placeholder="Enter case subject"
                                                value={caseSubject}
                                                onchange={handleCaseSubjectChange}>
                                            </lightning-input>
                                        </div>
                                        
                                        <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-4">
                                            <lightning-combobox
                                                label="Status"
                                                value={selectedCaseStatus}
                                                placeholder="Select status"
                                                options={caseStatusOptions}
                                                onchange={handleCaseStatusChange}>
                                            </lightning-combobox>
                                        </div>
                                    </template>

                                    <template if:true={showVoiceCallFilters}>
                                        <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-4">
                                            <lightning-combobox
                                                label="Call Type"
                                                value={selectedCallType}
                                                placeholder="Select call type"
                                                options={callTypeOptions}
                                                onchange={handleCallTypeChange}>
                                            </lightning-combobox>
                                        </div>
                                        
                                        <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-4">
                                            <lightning-combobox
                                                label="Status"
                                                value={selectedVoiceCallStatus}
                                                placeholder="Select status"
                                                options={voiceCallStatusOptions}
                                                onchange={handleVoiceCallStatusChange}>
                                            </lightning-combobox>
                                        </div>
                                    </template>
                                </div>
                                
                                <!-- Filter Action Buttons -->
                                <div class="slds-var-m-top_medium">
                                    <lightning-button-group>
                                        <lightning-button
                                            label="Apply Filters"
                                            variant="brand"
                                            onclick={handleApplyFilters}>
                                        </lightning-button>
                                        <lightning-button
                                            label="Clear Filters"
                                            variant="neutral"
                                            onclick={handleClearFilters}>
                                        </lightning-button>
                                    </lightning-button-group>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Search -->
                    <div class="slds-var-m-around_medium">
                        <lightning-input
                            type="text"
                            label={quickSearchLabel}
                            placeholder="Search current page results"
                            value={searchKey}
                            onchange={handleSearch}>
                        </lightning-input>
                    </div>

                    <!-- Data Table with Limited Height -->
                    <div class="slds-var-m-around_medium">
                        <div style="height: 400px; overflow-y: auto;">
                            <lightning-datatable
                                key-field="Id"
                                data={filteredRecords}
                                columns={recordColumns}
                                onrowselection={handleRowSelection}
                                max-row-selection="200"
                                show-row-number-column>
                            </lightning-datatable>
                        </div>
                    </div>

                    <!-- Pagination Controls -->
                    <template if:true={showPagination}>
                        <div class="slds-var-m-around_medium">
                            <div class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center">
                                <!-- Page info -->
                                <div class="slds-col">
                                    <p class="slds-text-body_small slds-text-color_weak">
                                        Showing {currentPageInfo} records
                                    </p>
                                </div>
                                
                                <!-- Navigation buttons -->
                                <div class="slds-col slds-no-flex">
                                    <lightning-button-group>
                                        <lightning-button
                                            label="First"
                                            variant="neutral"
                                            onclick={handleFirstPage}>
                                        </lightning-button>
                                        <lightning-button
                                            label="Previous"
                                            variant="neutral"
                                            onclick={handlePreviousPage}>
                                        </lightning-button>
                                        <lightning-button
                                            label="Next"
                                            variant="neutral"
                                            onclick={handleNextPage}>
                                        </lightning-button>
                                        <lightning-button
                                            label="Last"
                                            variant="neutral"
                                            onclick={handleLastPage}>
                                        </lightning-button>
                                    </lightning-button-group>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Action Section -->
                    <div class="slds-var-m-around_medium">
                        <div class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center">
                            <div class="slds-col">
                                <p class="slds-text-body_small slds-text-color_weak">
                                    <template if:true={selectedRecordIds.length}>
                                        {selectedRecordIds.length} {recordTypeLabel}(s) selected - {recordSelectionDescription}
                                    </template>
                                    <template if:false={selectedRecordIds.length}>
                                        No {recordTypeLabel}s selected
                                    </template>
                                </p>
                            </div>
                            <div class="slds-col slds-no-flex">
                                <lightning-button
                                    label="Create Test Batch"
                                    variant="brand"
                                    onclick={handleCreateAdvancedTestBatch}
                                    disabled={hasNoSelections}>
                                </lightning-button>
                            </div>
                        </div>
                    </div>
                </template>

            </lightning-card>
        </div>

    </div>

</template>
